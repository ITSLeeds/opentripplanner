---
title: "Advanced Features"
author: "Malcolm Morgan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{opentripplanner-advanced}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

The vignette introduces some of the more advanced features of OTP and gives some examples of the types of analysis that are possible when using OTP and R together.

### Recap

For this vignette, we will use the same data as the `getting_started` vignette. If you have not yet created the example graph you can set it up with the following commands. If you are using non-default settings see the `getting_started` vignette for full details.

```{r eval =FALSE}
library(opentripplanner)
# Path to a folder containing the OTP.jar file, change to where you saved the file.
path_otp <- "C:/Users/Public/otp.jar"
path_data <- getwd() # find the current working directory
log <- otp_build_graph(otp = path_otp, dir = path_data)
otp_setup(otp = path_otp, dir = path_data, analyst = T)
otpcon <- otp_connect()

```

## Isochrones

Now that we have a working instance of OTP, we'll use it to generate some travel-time isochrones. We are interested in visualising how long it takes to access Ryde ferry using public transport from different parts of the island. We will do this by requesting isochrones from OTP for 15, 30, 45, 60, 75 and 90 minutes. This can be achieved with a single function `otp_isochrone()`.

Isochrones requires the analyst extension to OTP. 

```{r eval=FALSE}
ferry_current  <- otp_isochrone(otpcon = otpcon,
            fromPlace = c(50.732429, -1.159494), # latlong of Ryde ferry
            mode = c("WALK","TRANSIT"),
            maxWalkDistance = 2000,
            date_time = as.POSIXct(strptime("2018-06-03 13:30", "%Y-%m-%d %H:%M")),
            cutoffSec = c(15, 30, 45, 60, 75, 90) * 60 ) # Cut offs in seconds
ferry_current$minutes = ferry_current$time / 60 # Convert back to minutes

```

We can visualise the isochrones on a map using the `tmap` package.

```{r, eval=FALSE}
library(tmap)                       # Load the tmap package
tmap_mode("view")                   # Set tmap to interative viewing
map <- tm_shape(ferry_current) +  # Build the map
  tm_fill("minutes",
          breaks = c(0, 15.001, 30.001, 45.001, 60.001, 75.001, 90.001),
          style = "fixed",
          palette = "-RdYlBu") +
  tm_borders()
map                                 # Plot the map
```

You should see a map like this.

```{r, echo=FALSE, fig.align='center', fig.cap="\\label{fig:otpgui}Isochrones from Ryde ferry"}
knitr::include_graphics("images/isochrone.jpg")
```

## Batch Routing

In this final part of the tutorial, we are going to automate querying the OTP API to generate large quantities of route data - potentially for many thousands of origin: destination pairs. In this example, we will gather data on travel times between each of the LSOAs in on the Isle of White and the Rye Ferry.

To do this we will be using the `otp_route_batch` function.

We'll start by importing the sample data

```{r, eval=FALSE}
download.file("https://github.com/ITSLeeds/opentripplanner/releases/download/0.1/centroids.gpkg", 
              destfile = "centroids.gpkg", mode="wb")
lsoa <- sf::st_read("centroids.gpkg")
head(lsoa)
```

`otp_plan_batch` requires the fromPlace and the toPlace to each be either 2 x m matrices where each row is a latitude/longitude pair or an SF data.frame of only POINTS. The number of rows in fromPlace and toPlace must be the same. So we will repeat the coordinates for the Rye Ferry for each LSOA point.


```{r, eval=FALSE}
toPlace <- matrix(rep(c(50.732429, -1.159494),nrow(lsoa)), ncol = 2, byrow = TRUE)
head(toPlace)
```

Now we can use the `otp_plan_batch` to find the routes

```{r, eval=FALSE}
routes <- otp_plan_batch(otpcon = otpcon,
                         fromPlace = lsoa,
                         toPlace = toPlace)
```


You may get some error message returned as OTP is unable to find some of the routes. The `otp_plan_batch` will skip over errors and return all the routes it can get. It will then print out any error messages. You will have also noticed the handy progress bar.

You can plot the routes using `tmap` 

If you do plot all the routes it should look something like this:

```{r, echo=FALSE, fig.align='center', fig.cap="\\label{fig:route2airport}Driving Routes to Rye Ferry"}
knitr::include_graphics("images/routes_to_ferry.jpg")
```

